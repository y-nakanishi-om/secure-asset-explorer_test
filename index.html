<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Secure Asset Explorer - Final Pro Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --ui-scale: 1.0;
        }

        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; background-color: #020617; color: #f8fafc; }
        
        /* PDF Settings */
        .pdf-canvas-container { display: flex; flex-direction: column; align-items: center; gap: 32px; padding: 40px 0; width: 100%; background-color: transparent; }
        .pdf-page-canvas { display: block; max-width: 95%; height: auto !important; box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.7); background-color: white; border-radius: 12px; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; border: 2px solid #020617; }
        
        .loader { border: 4px solid rgba(99, 102, 241, 0.1); border-top: 4px solid #6366f1; border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .asset-card { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); user-select: none; position: relative; }
        .asset-card:hover { transform: translateY(-8px); filter: brightness(1.1); }
        .asset-card.selected { outline: 4px solid #6366f1; outline-offset: 2px; }
        
        .glass-header { 
            background: rgba(2, 6, 23, 0.95); 
            backdrop-filter: blur(32px); 
            -webkit-backdrop-filter: blur(32px); 
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        #mediaContainer { 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            display: flex;
            align-items: center; 
            justify-content: center;
            background: black;
            position: relative;
        }
        
        #zoomWrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: auto; 
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center center;
            flex-shrink: 0;
            padding: 40px; 
            box-sizing: border-box;
            min-height: 100%;
        }

        #zoomWrapper img, #zoomWrapper .pdf-canvas-container { margin: auto; flex-shrink: 0; }
        #mediaContainer img { max-width: 95%; max-height: 90vh; object-fit: contain; display: block; border-radius: 16px; box-shadow: 0 40px 80px rgba(0,0,0,0.8); }
        
        .nav-btn {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(-50%);
        }
        .nav-btn:hover { background: rgba(99, 102, 241, 0.4); transform: translateY(-50%) scale(1.1); color: white; }

        .hide-header header { transform: translateY(100%); pointer-events: none; }
        #exitFocusBtn { display: none; }
        .hide-header #exitFocusBtn { display: flex; }

        .custom-select {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #cbd5e1;
            font-size: calc(13px * var(--ui-scale));
            font-weight: 800;
            padding: calc(10px * var(--ui-scale)) calc(12px * var(--ui-scale));
            border-radius: 10px;
            outline: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lightbox-controls {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            padding: 0.6rem;
            border-radius: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.6);
            transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .lightbox-controls.idle { opacity: 0.15; pointer-events: auto; }
        .lightbox-controls.idle:hover { opacity: 1; }

        .controls-inner { display: flex; align-items: center; gap: 0.75rem; }

        .zoom-group { display: flex; gap: 0.4rem; border-right: 1px solid rgba(255, 255, 255, 0.1); padding-right: 0.75rem; }

        .zoom-btn, .close-lightbox-btn {
            width: 3rem; height: 3rem; display: flex; align-items: center; justify-content: center;
            background: rgba(255, 255, 255, 0.05); color: white; border-radius: 1rem; transition: all 0.2s;
        }
        .zoom-btn:active, .close-lightbox-btn:active { transform: scale(0.9); background: rgba(255, 255, 255, 0.2); }
        .zoom-btn.active { background: rgba(99, 102, 241, 0.4); color: white; }
        
        .progress-container { width: 100%; height: 3px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; margin-top: 8px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: #6366f1; transition: width 0.1s linear; }

        .dynamic-ui-text { font-size: calc(0.95rem * var(--ui-scale)); }
        .dynamic-ui-btn { 
            padding: calc(0.6rem * var(--ui-scale)) calc(1rem * var(--ui-scale)); 
            font-size: calc(0.75rem * var(--ui-scale));
            border-radius: calc(0.5rem * var(--ui-scale));
            white-space: nowrap;
        }
        .dynamic-ui-icon { 
            width: calc(2.8rem * var(--ui-scale)); 
            height: calc(2.8rem * var(--ui-scale)); 
            border-radius: calc(0.7rem * var(--ui-scale));
        }
        .dynamic-ui-icon svg {
            width: calc(1.6rem * var(--ui-scale));
            height: calc(1.6rem * var(--ui-scale));
        }

        @keyframes pulse-slow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.98); }
        }
        .animate-pulse-slow { animation: pulse-slow 4s ease-in-out infinite; }

        #dropZone.drag-over {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
            transform: scale(1.02);
        }
    </style>
</head>
<body class="min-h-screen selection:bg-indigo-500/30 overflow-x-hidden">

    <!-- Auth Layer -->
    <div id="authOverlay" class="fixed inset-0 z-[200] bg-slate-950 flex flex-col items-center justify-center p-8">
        <div class="w-full max-w-lg mb-12 flex flex-col items-center animate-pulse-slow">
            <img src="logo.png" alt="Secure Vault" class="w-full max-w-[420px] h-auto object-contain drop-shadow-[0_20px_50px_rgba(79,70,229,0.4)]" onerror="this.src='https://via.placeholder.com/500x200/020617/ffffff?text=SECURE+VAULT'">
            <div class="w-24 h-1 bg-indigo-600/30 rounded-full mt-8"></div>
        </div>

        <div class="w-full max-w-[340px] flex flex-col gap-5">
            <div class="relative group">
                <input type="password" id="masterPassword" class="w-full bg-slate-900/80 border border-slate-800 rounded-2xl px-6 py-6 text-center text-white text-2xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all" placeholder="PASSWORD" autocomplete="current-password">
            </div>
            <button onclick="authenticate()" class="w-full bg-indigo-600 hover:bg-indigo-50 text-white font-black py-6 rounded-2xl transition-all shadow-2xl active:scale-[0.98] uppercase tracking-[0.2em] text-xl">
                log in
            </button>
        </div>

        <button onclick="requestSystemReset()" class="fixed bottom-8 right-8 text-slate-700 hover:text-red-500 text-[10px] font-black uppercase tracking-[0.3em] transition-colors py-2 px-4">
            Initialize System
        </button>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden opacity-0 transition-all duration-700 pb-48">
        <main class="max-w-[2560px] mx-auto px-6 py-12">
            <div id="fileGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-8"></div>
        </main>

        <header id="mainHeader" class="glass-header fixed bottom-0 left-0 right-0 z-40">
            <div class="max-w-[2560px] mx-auto px-4 py-3 flex flex-nowrap justify-between items-center gap-2">
                
                <!-- Logo -->
                <div class="flex items-center gap-3 shrink-0">
                    <div class="dynamic-ui-icon bg-indigo-600 flex items-center justify-center rotate-2 shadow-xl shadow-indigo-600/30">
                        <svg class="text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                    </div>
                </div>

                <!-- Action Panel (Single Row Layout) -->
                <div class="flex flex-nowrap items-center justify-center gap-3 lg:gap-6 flex-1 overflow-hidden">
                    
                    <!-- Group 1: Storage IO -->
                    <div id="ioActions" class="flex flex-nowrap items-center gap-1.5 shrink-0">
                        <span id="fileCount" class="text-[10px] font-black text-slate-500 uppercase tracking-widest hidden lg:inline mr-2">登録数: 0</span>
                        <input type="file" id="importInput" class="hidden" accept=".json" onchange="importFullBackup(this)">
                        <button onclick="document.getElementById('importInput').click()" class="dynamic-ui-btn bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-700">読込</button>
                        <button onclick="exportFullBackup()" id="exportBtn" class="dynamic-ui-btn bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-700">書込</button>
                    </div>

                    <!-- Divider -->
                    <div class="h-6 w-px bg-slate-800 shrink-0"></div>

                    <!-- Main Group: Add / Play / Select -->
                    <div class="flex flex-nowrap items-center gap-2 shrink-0">
                        <button id="addBtn" onclick="toggleUploadModal()" class="dynamic-ui-btn bg-indigo-600 hover:bg-indigo-500 text-white font-black shadow-lg">追加</button>
                        
                        <!-- Direct Play: If select is on, plays selected. If off, plays all. -->
                        <button id="mainPlayBtn" onclick="handlePlayClick()" class="dynamic-ui-btn bg-indigo-600 hover:bg-indigo-500 text-white font-black shadow-lg">再生</button>
                        
                        <!-- Select Mode Toggle: Purely for preparation/deletion -->
                        <button onclick="toggleSelectMode()" id="deleteModeBtn" class="dynamic-ui-btn bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-700">選択</button>
                    </div>

                    <!-- Divider -->
                    <div id="selectDivider" class="h-6 w-px bg-slate-800 shrink-0 hidden"></div>

                    <!-- Selection-only Bulk Actions -->
                    <div id="selectActions" class="flex flex-nowrap items-center gap-2 hidden shrink-0">
                        <button onclick="deleteSelectedAssets()" id="bulkDeleteBtn" class="dynamic-ui-btn bg-red-600 hover:bg-red-500 text-white font-black shadow-lg">一括削除</button>
                        <button onclick="toggleSelectAll()" class="dynamic-ui-btn bg-slate-800 text-slate-300 border border-slate-700 hidden lg:block">全選択</button>
                    </div>

                    <!-- Divider -->
                    <div class="h-6 w-px bg-slate-800 shrink-0"></div>

                    <!-- Sort -->
                    <div id="sortActions" class="shrink-0">
                        <select id="sortSelect" onchange="renderGrid()" class="custom-select">
                            <option value="reg_desc">登録順(新)</option>
                            <option value="reg_asc">登録順(古)</option>
                            <option value="file_desc">更新日(新)</option>
                            <option value="file_asc">更新日(古)</option>
                        </select>
                    </div>
                </div>

                <!-- System Controls -->
                <div class="flex items-center gap-2 shrink-0">
                    <div class="flex items-center bg-slate-900/50 p-1 rounded-lg border border-white/5">
                        <button onclick="adjustUIScale(-0.1)" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-white rounded transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M20 12H4"/></svg>
                        </button>
                        <button onclick="adjustUIScale(0.1)" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-white rounded transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M12 4v16m8-8H4"/></svg>
                        </button>
                    </div>

                    <div class="flex gap-1 border-l border-slate-800 pl-3">
                        <button onclick="toggleFocusMode()" class="text-slate-500 hover:text-white p-2" title="枠内最大化"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg></button>
                        <button onclick="toggleFullScreen()" class="text-slate-500 hover:text-white p-2" title="全画面"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg></button>
                        <button onclick="lockVault()" class="text-slate-500 hover:text-white p-2" title="ロック"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" /></svg></button>
                    </div>
                </div>
            </div>
            <div id="storageUsage" class="absolute top-[-20px] left-1/2 -translate-x-1/2 text-[8px] font-black text-slate-600 uppercase tracking-widest pointer-events-none opacity-40">STORAGE STATUS LOADING...</div>
        </header>

        <button id="exitFocusBtn" onclick="toggleFocusMode()" class="fixed bottom-32 right-8 z-50 bg-indigo-600 hover:bg-indigo-50 text-white w-16 h-16 flex items-center justify-center rounded-full shadow-2xl transition-all active:scale-90 animate-bounce">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
    </div>

    <!-- Lightbox (Zoomed View) -->
    <div id="lightbox" class="fixed inset-0 z-50 hidden flex flex-col bg-black transition-all overflow-hidden select-none">
        <div id="lightboxControls" class="lightbox-controls">
            <div class="controls-inner">
                <div class="zoom-group">
                    <button onclick="zoomContent(1.25)" class="zoom-btn" title="拡大"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M12 4v16m8-8H4"/></svg></button>
                    <button onclick="zoomContent(0.8)" class="zoom-btn" title="縮小"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M20 12H4"/></svg></button>
                    <button onclick="resetZoom()" class="zoom-btn" title="リセット"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M4 4h6v6H4zm10 0h6v6h-6zM4 14h6v6H4zm10 0h6v6h-6z"/></svg></button>
                    <button onclick="rotateContent()" class="zoom-btn" title="回転"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg></button>
                </div>
                <button id="slideshowBtn" onclick="toggleSlideshow()" class="zoom-btn" title="スライドショー">
                    <svg id="playIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="pauseIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                <button id="lightboxCloseBtn" onclick="closeLightboxUI()" class="close-lightbox-btn" title="閉じる"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
        </div>

        <button id="prevBtn" class="nav-btn fixed left-6 top-1/2 w-16 h-16 flex items-center justify-center text-white/40 z-[70] rounded-full shadow-2xl"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M15 19l-7-7 7-7" /></svg></button>
        <button id="nextBtn" class="nav-btn fixed right-6 top-1/2 w-16 h-16 flex items-center justify-center text-white/40 z-[70] rounded-full shadow-2xl"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M9 5l7 7-7 7" /></svg></button>
        
        <div id="mediaContainer">
            <div id="zoomWrapper">
                <div id="mediaLoader" class="absolute inset-0 flex items-center justify-center z-[75] bg-black/90"><div class="loader"></div></div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 z-[300] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-sm rounded-[3rem] p-10 shadow-2xl text-center">
            <h3 id="confirmTitle" class="text-2xl font-black text-white mb-4 uppercase italic">確認</h3>
            <p id="confirmMessage" class="text-slate-400 text-sm mb-10 leading-relaxed">メッセージ</p>
            <div class="flex gap-4">
                <button onclick="closeConfirm()" class="flex-1 bg-slate-800 text-white font-bold py-5 rounded-2xl hover:bg-slate-700 transition-all">キャンセル</button>
                <button id="confirmBtn" class="flex-1 bg-red-600 text-white font-bold py-5 rounded-2xl hover:bg-red-500 transition-all shadow-xl">実行</button>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-lg rounded-[4rem] p-12 shadow-2xl relative text-center">
            <button onclick="toggleUploadModal()" class="absolute bottom-10 right-10 bg-slate-800 text-slate-400 hover:text-white p-5 rounded-2xl transition-colors"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M6 18L18 6M6 6l12 12"/></svg></button>
            <div id="dropZone" class="border-2 border-dashed border-slate-700 bg-slate-950/50 rounded-[3rem] p-16 flex flex-col items-center justify-center group cursor-pointer hover:border-indigo-500 transition-all">
                <div class="w-24 h-24 bg-slate-800 rounded-[2rem] flex items-center justify-center mb-8 group-hover:scale-110 transition-all shadow-xl"><svg class="w-12 h-12 text-slate-500 group-hover:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path d="M12 4.5v15m7.5-7.5h-15"></path></svg></div>
                <h2 class="text-3xl font-black text-white mb-2 uppercase italic tracking-tighter text-center">Secure Storage</h2>
                <p class="text-slate-500 text-sm text-center">ここにドロップして保管</p>
                <input type="file" id="fileInput" class="hidden" multiple accept="image/*,application/pdf">
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-44 left-1/2 -translate-x-1/2 z-[100] bg-indigo-600 text-white px-10 py-5 rounded-3xl font-bold shadow-2xl transition-all transform translate-y-28 opacity-0 pointer-events-none text-sm text-center min-w-[320px]">メッセージ</div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const CMAP_URL = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/';
        const DB_NAME = "AssetStorage_Final_v4";
        const STORE_NAME = "assets";
        const CONFIG_STORE = "config";
        let db = null, library = [], currentIdx = -1, sessionKey = null, deleteTargetIds = [];
        let isSelectMode = false, selectedIds = new Set();
        let currentPDF = null, currentZoom = 1, uiScale = 1.0, currentRotation = 0;
        let controlsTimer = null; 

        // Slideshow
        let isSlideshowPlaying = false;
        let slideshowList = [];
        let slideshowTimer = null;
        let slideshowProgressInterval = null;
        const SLIDE_DURATION = 5000; 
        let slideTimeElapsed = 0;
        let currentPDFPageIdx = 1;

        const generateId = () => (typeof crypto.randomUUID === 'function') ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).substring(2);

        const initDB = () => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onupgradeneeded = e => {
                const database = e.target.result;
                database.createObjectStore(STORE_NAME, { keyPath: "id" });
                database.createObjectStore(CONFIG_STORE, { keyPath: "key" });
            };
            request.onsuccess = e => { db = e.target.result; };
        };
        initDB();

        function adjustUIScale(delta) {
            uiScale = Math.min(Math.max(uiScale + delta, 0.6), 2.0);
            document.documentElement.style.setProperty('--ui-scale', uiScale);
            const pb = Math.round(180 * uiScale);
            const mc = document.getElementById('mainContent');
            if (mc) mc.style.paddingBottom = pb + 'px';
            showToast(`UIサイズ: ${Math.round(uiScale * 100)}%`);
        }

        async function deriveKey(password, salt) {
            return CryptoJS.PBKDF2(password, salt, { keySize: 256 / 32, iterations: 100000 });
        }

        async function authenticate() {
            if (!db) { showToast("準備中..."); return; }
            const passEl = document.getElementById('masterPassword');
            const pass = passEl.value;
            if (pass.length < 4) { showToast("パスワードが短すぎます"); return; }
            
            showToast("認証中...");
            const tx = db.transaction(CONFIG_STORE, "readwrite");
            const configStore = tx.objectStore(CONFIG_STORE);
            let saltObj = await new Promise(r => { const req = configStore.get("system_salt"); req.onsuccess = () => r(req.result); });
            let challengeObj = await new Promise(r => { const req = configStore.get("auth_challenge"); req.onsuccess = () => r(req.result); });
            
            if (!saltObj) {
                const newSalt = CryptoJS.lib.WordArray.random(128/8).toString();
                saltObj = { key: "system_salt", value: newSalt };
                configStore.put(saltObj);
            }
            
            const derived = await deriveKey(pass, saltObj.value);
            if (challengeObj) {
                const testResult = decryptWithKey(challengeObj.value, challengeObj.iv, derived);
                if (testResult !== "OK") { showToast("パスワードが正しくありません"); passEl.value = ""; return; }
            } else {
                const iv = CryptoJS.lib.WordArray.random(128/8);
                const encryptedChallenge = CryptoJS.AES.encrypt("OK", derived, { iv: iv }).toString();
                configStore.put({ key: "auth_challenge", value: encryptedChallenge, iv: iv.toString() });
            }
            
            sessionKey = derived;
            passEl.value = "";
            document.getElementById('authOverlay').style.display = 'none';
            const main = document.getElementById('mainContent');
            main.classList.remove('hidden', 'opacity-0');
            
            setTimeout(async () => {
                main.classList.add('opacity-100');
                await loadFromDB();
                window.dispatchEvent(new Event('resize'));
                updateStorageUsage();
            }, 100);
        }

        function requestSystemReset() {
            const modal = document.getElementById('confirmModal');
            const title = document.getElementById('confirmTitle');
            const msg = document.getElementById('confirmMessage');
            const btn = document.getElementById('confirmBtn');

            title.textContent = "システム初期化";
            msg.textContent = "保存されているすべてのデータとパスワードを消去し、初期状態に戻します。この操作は取り消せません。よろしいですか？";
            btn.textContent = "初期化を実行";
            btn.className = "flex-1 bg-red-600 text-white font-bold py-5 rounded-2xl hover:bg-red-500 transition-all shadow-xl";

            btn.onclick = () => {
                msg.textContent = "【最終確認】本当にすべて消去されます。よろしいですか？";
                btn.textContent = "確定";
                
                btn.onclick = () => {
                    showToast("初期化中...");
                    if (db) { db.close(); db = null; }
                    const req = indexedDB.deleteDatabase(DB_NAME);
                    req.onsuccess = () => { showToast("完了。再起動します。"); setTimeout(() => location.reload(), 1500); };
                    req.onerror = () => { showToast("初期化に失敗しました。"); initDB(); };
                    req.onblocked = () => { showToast("他のタブで開いているため実行できません"); };
                };
            };
            modal.classList.remove('hidden');
        }

        async function updateStorageUsage() {
            if (navigator.storage && navigator.storage.estimate) {
                try {
                    const estimate = await navigator.storage.estimate();
                    const usage = estimate.usage || 0;
                    const quota = estimate.quota || 0;
                    const usedMB = (usage / (1024 * 1024)).toFixed(1);
                    const availableGB = ((quota - usage) / (1024 * 1024 * 1024)).toFixed(1);
                    const usageEl = document.getElementById('storageUsage');
                    if (usageEl) usageEl.textContent = `USED: ${usedMB}MB / FREE: ${availableGB}GB`;
                } catch(e) {}
            }
        }

        async function loadFromDB() {
            if (!db || !sessionKey) return;
            const tx = db.transaction(STORE_NAME, "readonly");
            const data = await new Promise(r => { const req = tx.objectStore(STORE_NAME).getAll(); req.onsuccess = () => r(req.result); req.onerror = () => r([]); });
            library = data;
            renderGrid();
        }

        function decryptWithKey(cipherText, ivHex, key) {
            try {
                const iv = CryptoJS.enc.Hex.parse(ivHex);
                const bytes = CryptoJS.AES.decrypt(cipherText, key, { iv: iv });
                return bytes.toString(CryptoJS.enc.Utf8) || null;
            } catch(e) { return null; }
        }

        function encrypt(text) {
            if (!text) return "";
            const iv = CryptoJS.lib.WordArray.random(128/8);
            const encrypted = CryptoJS.AES.encrypt(text, sessionKey, { iv: iv });
            return iv.toString() + ":" + encrypted.toString();
        }

        function decrypt(cipherWithIv) {
            if (!cipherWithIv || !sessionKey) return null;
            try {
                const parts = cipherWithIv.split(":");
                if (parts.length < 2) return null;
                return decryptWithKey(parts[1], parts[0], sessionKey);
            } catch(e) { return null; }
        }

        function getSortedLibrary() {
            const sortVal = document.getElementById('sortSelect').value;
            let sortedList = [...library];
            if (sortVal === 'reg_desc') sortedList.sort((a, b) => b.timestamp - a.timestamp);
            else if (sortVal === 'reg_asc') sortedList.sort((a, b) => a.timestamp - b.timestamp);
            else if (sortVal === 'file_desc') sortedList.sort((a, b) => parseInt(decrypt(b.fileModified) || b.timestamp) - parseInt(decrypt(a.fileModified) || a.timestamp));
            else if (sortVal === 'file_asc') sortedList.sort((a, b) => parseInt(decrypt(a.fileModified) || a.timestamp) - parseInt(decrypt(b.fileModified) || b.timestamp));
            else if (sortVal === 'name_asc') sortedList.sort((a, b) => (decrypt(a.name) || "").localeCompare(decrypt(b.name) || "", 'ja'));
            else if (sortVal === 'name_desc') sortedList.sort((a, b) => (decrypt(b.name) || "").localeCompare(decrypt(a.name) || "", 'ja'));
            return sortedList;
        }

        function renderGrid() {
            const grid = document.getElementById('fileGrid');
            grid.innerHTML = '';
            
            if (library.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-48 text-center border-2 border-dashed border-slate-800 rounded-[4rem] bg-slate-900/10"><p class="text-slate-600 font-bold uppercase tracking-[0.4em] text-[10px]">No assets found</p></div>`;
                const fc = document.getElementById('fileCount');
                if (fc) fc.textContent = `登録数: 0`;
                return;
            }

            const displayList = getSortedLibrary();
            displayList.forEach((item, index) => {
                const card = document.createElement('div');
                const isSelected = selectedIds.has(item.id);
                card.className = `asset-card group bg-slate-900 border border-slate-800 rounded-3xl overflow-hidden shadow-2xl cursor-pointer ${isSelected ? 'selected' : ''}`;
                const name = decrypt(item.name) || "ENCRYPTED DATA";
                const thumb = decrypt(item.thumbnail);
                
                card.innerHTML = `
                    <div class="absolute top-4 left-4 z-20 flex gap-2">
                        ${!isSelectMode ? `<button class="del-btn bg-slate-950/90 text-white/40 p-3 rounded-2xl shadow-xl border border-white/5 hover:bg-red-600 hover:text-white transition-all opacity-0 group-hover:opacity-100 scale-90 group-hover:scale-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>` : ''}
                        ${isSelectMode ? `<div class="w-8 h-8 rounded-full border-2 border-white/20 flex items-center justify-center transition-all ${isSelected ? 'bg-indigo-600 border-indigo-600' : 'bg-slate-900/80'}"><svg class="w-5 h-5 text-white ${isSelected ? '' : 'hidden'}" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg></div>` : ''}
                    </div>
                    <div class="aspect-[4/5] w-full bg-slate-950 flex items-center justify-center overflow-hidden relative">
                        <img src="${thumb || ''}" class="max-w-full max-h-full object-contain group-hover:scale-110 transition-transform duration-1000" loading="lazy">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-950/60 via-transparent to-transparent pointer-events-none"></div>
                    </div>
                    <div class="p-4 border-t border-slate-800/50 text-center bg-slate-900"><p class="text-[10px] font-black text-slate-100 truncate tracking-tight uppercase">${name}</p></div>
                `;
                card.onclick = (e) => {
                    if (isSelectMode) {
                        if (selectedIds.has(item.id)) selectedIds.delete(item.id);
                        else selectedIds.add(item.id);
                        renderGrid();
                        updateBulkDeleteCount();
                    } else {
                        if (!e.target.closest('button')) openLightbox(index, displayList);
                    }
                };
                const delBtn = card.querySelector('.del-btn');
                if (delBtn) {
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteTargetIds = [item.id];
                        const modal = document.getElementById('confirmModal');
                        document.getElementById('confirmTitle').textContent = "資産の削除";
                        document.getElementById('confirmMessage').textContent = "この資産を完全に削除します。";
                        const btn = document.getElementById('confirmBtn');
                        btn.textContent = "削除実行";
                        btn.className = "flex-1 bg-red-600 text-white font-bold py-5 rounded-2xl hover:bg-red-500 transition-all shadow-xl";
                        btn.onclick = async () => {
                            const tx = db.transaction(STORE_NAME, "readwrite");
                            const store = tx.objectStore(STORE_NAME);
                            deleteTargetIds.forEach(id => store.delete(id));
                            tx.oncomplete = () => { closeConfirm(); if (isSelectMode) toggleSelectMode(); loadFromDB(); showToast("削除しました"); updateStorageUsage(); };
                        };
                        modal.classList.remove('hidden');
                    };
                }
                grid.appendChild(card);
            });
            const fc = document.getElementById('fileCount');
            if (fc) fc.textContent = `登録数: ${library.length}`;
        }

        // --- Improved UX: Separate preparation (Select) and execution (Play) ---
        function toggleSelectMode() {
            isSelectMode = !isSelectMode;
            if (!isSelectMode) selectedIds.clear();
            
            // Toggle visibility to keep it in 1 row
            document.getElementById('ioActions').classList.toggle('hidden', isSelectMode);
            document.getElementById('sortActions').classList.toggle('hidden', isSelectMode);
            document.getElementById('addBtn').classList.toggle('hidden', isSelectMode);
            document.getElementById('selectDivider').classList.toggle('hidden', !isSelectMode);
            document.getElementById('selectActions').classList.toggle('hidden', !isSelectMode);
            
            const delModeBtn = document.getElementById('deleteModeBtn');
            if (isSelectMode) {
                delModeBtn.classList.remove('bg-slate-800');
                delModeBtn.classList.add('bg-indigo-900', 'ring-2', 'ring-indigo-500');
                delModeBtn.textContent = "戻る";
            } else {
                delModeBtn.classList.remove('bg-indigo-900', 'ring-2', 'ring-indigo-500');
                delModeBtn.classList.add('bg-slate-800');
                delModeBtn.textContent = "選択";
            }

            updateBulkDeleteCount();
            renderGrid();
        }

        // Play Button logic: Direct playback.
        function handlePlayClick() {
            // Start slideshow. If selected items exist, play them. Otherwise play all.
            startSlideshow(selectedIds.size > 0);
            
            // If select mode was on, turn it off upon playing
            if (isSelectMode) toggleSelectMode();
        }

        function toggleSelectAll() {
            if (selectedIds.size === library.length) selectedIds.clear();
            else library.forEach(item => selectedIds.add(item.id));
            renderGrid();
            updateBulkDeleteCount();
        }

        function updateBulkDeleteCount() {
            const btn = document.getElementById('bulkDeleteBtn');
            if(btn) btn.textContent = `一括削除 (${selectedIds.size})`;
        }

        function deleteSelectedAssets() {
            if (selectedIds.size === 0) return;
            deleteTargetIds = Array.from(selectedIds);
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmTitle').textContent = "一括削除";
            document.getElementById('confirmMessage').textContent = `${selectedIds.size} 件の資産を完全に削除します。`;
            const btn = document.getElementById('confirmBtn');
            btn.textContent = "選択した項目を削除";
            btn.className = "flex-1 bg-red-600 text-white font-bold py-5 rounded-2xl hover:bg-red-500 transition-all shadow-xl";
            btn.onclick = async () => {
                const tx = db.transaction(STORE_NAME, "readwrite");
                const store = tx.objectStore(STORE_NAME);
                deleteTargetIds.forEach(id => store.delete(id));
                tx.oncomplete = () => { closeConfirm(); if (isSelectMode) toggleSelectMode(); loadFromDB(); showToast("削除しました"); updateStorageUsage(); };
            };
            modal.classList.remove('hidden');
        }

        async function handleFiles(fileList) {
            if (!sessionKey) return;
            showToast("処理中...");
            for (const file of Array.from(fileList)) {
                try {
                    const type = file.type.startsWith('image/') ? 'image' : (file.type === 'application/pdf' ? 'pdf' : null);
                    if (!type) continue;
                    let thumbData = "";
                    if (type === 'pdf') {
                        const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer(), cMapUrl: CMAP_URL, cMapPacked: true }).promise;
                        const page = await pdf.getPage(1);
                        const canvas = document.createElement('canvas');
                        const vp = page.getViewport({ scale: 0.4 });
                        canvas.height = vp.height; canvas.width = vp.width;
                        await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
                        thumbData = canvas.toDataURL('image/jpeg', 0.6);
                        await pdf.destroy();
                    } else {
                        thumbData = await new Promise(r => { const rd = new FileReader(); rd.onload = e => r(e.target.result); rd.readAsDataURL(file); });
                    }
                    const base64 = await new Promise(r => { const rd = new FileReader(); rd.onload = e => r(e.target.result); rd.readAsDataURL(file); });
                    const secureItem = { id: generateId(), name: encrypt(file.name), type: encrypt(type), size: encrypt((file.size/1024/1024).toFixed(2) + " MB"), thumbnail: encrypt(thumbData), data: encrypt(base64), timestamp: Date.now(), fileModified: encrypt(file.lastModified.toString()) };
                    const tx = db.transaction(STORE_NAME, "readwrite");
                    tx.objectStore(STORE_NAME).put(secureItem);
                    await new Promise(r => tx.oncomplete = r);
                } catch (err) { showToast("エラーが発生しました"); }
            }
            showToast("完了しました");
            if (!document.getElementById('uploadModal').classList.contains('hidden')) toggleUploadModal();
            loadFromDB();
            updateStorageUsage();
        }

        function wakeControls() {
            const ctrl = document.getElementById('lightboxControls');
            if (!ctrl) return;
            ctrl.classList.remove('idle');
            clearTimeout(controlsTimer);
            controlsTimer = setTimeout(() => {
                ctrl.classList.add('idle');
            }, 2000); 
        }

        function startSlideshow(onlySelected = false) {
            const fullList = getSortedLibrary();
            if (onlySelected && selectedIds.size > 0) {
                slideshowList = fullList.filter(item => selectedIds.has(item.id));
            } else {
                slideshowList = fullList;
            }
            
            if (slideshowList.length === 0) {
                showToast("再生可能なコンテンツがありません");
                return;
            }

            isSlideshowPlaying = true;
            openLightbox(0, slideshowList);
            updateSlideshowUI();
            resetSlideshowTimer();
        }

        function toggleSlideshow() {
            isSlideshowPlaying = !isSlideshowPlaying;
            if (isSlideshowPlaying) {
                if (slideshowList.length === 0) slideshowList = getSortedLibrary();
                resetSlideshowTimer();
            } else {
                stopSlideshowTimer();
            }
            updateSlideshowUI();
        }

        function stopSlideshowTimer() {
            clearTimeout(slideshowTimer);
            clearInterval(slideshowProgressInterval);
            slideTimeElapsed = 0;
            const pb = document.getElementById('progressBar');
            if (pb) pb.style.width = '0%';
        }

        function resetSlideshowTimer() {
            stopSlideshowTimer();
            if (!isSlideshowPlaying) return;

            const updateInterval = 100; 
            slideshowProgressInterval = setInterval(() => {
                slideTimeElapsed += updateInterval;
                const progress = (slideTimeElapsed / SLIDE_DURATION) * 100;
                const pb = document.getElementById('progressBar');
                if (pb) pb.style.width = Math.min(progress, 100) + '%';
            }, updateInterval);

            slideshowTimer = setTimeout(() => { advanceSlideshow(); }, SLIDE_DURATION);
        }

        async function advanceSlideshow() {
            if (currentPDF && currentPDFPageIdx < currentPDF.numPages) {
                currentPDFPageIdx++;
                const mc = document.getElementById('mediaContainer');
                const canvases = document.querySelectorAll('.pdf-page-canvas');
                if (canvases[currentPDFPageIdx - 1]) {
                    mc.scrollTo({
                        top: canvases[currentPDFPageIdx - 1].offsetTop - 40,
                        behavior: 'smooth'
                    });
                }
                resetSlideshowTimer();
                return;
            }

            currentPDFPageIdx = 1;
            const nextIdx = (currentIdx + 1) % slideshowList.length;
            await openLightbox(nextIdx, slideshowList);
            resetSlideshowTimer();
        }

        function updateSlideshowUI() {
            const btn = document.getElementById('slideshowBtn');
            const playIcon = document.getElementById('playIcon');
            const pauseIcon = document.getElementById('pauseIcon');
            if (isSlideshowPlaying) {
                btn.classList.add('active');
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            } else {
                btn.classList.remove('active');
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            }
        }

        async function openLightbox(index, sortedList = null) {
            const list = sortedList || getSortedLibrary();
            if (list.length === 0) return;
            if (index < 0 || index >= list.length) index = 0;
            currentIdx = index;

            const item = list[index], container = document.getElementById('zoomWrapper'), loader = document.getElementById('mediaLoader'), lb = document.getElementById('lightbox'), mc = document.getElementById('mediaContainer');
            if (currentPDF) { await currentPDF.destroy(); currentPDF = null; }
            
            loader.style.display = 'flex';
            container.querySelectorAll('img, canvas, div:not(#mediaLoader)').forEach(el => el.remove());
            
            mc.scrollTop = 0; mc.scrollLeft = 0;
            mc.style.alignItems = 'center';
            currentZoom = 1;
            currentRotation = 0;
            currentPDFPageIdx = 1; 
            
            lb.classList.remove('hidden'); 
            document.body.style.overflow = 'hidden';
            
            wakeControls();
            
            const decryptedData = decrypt(item.data), type = decrypt(item.type);
            if (!decryptedData) { showToast("復号に失敗しました"); loader.style.display = 'none'; return; }
            
            if (type === 'image') {
                const img = new Image(); 
                img.src = decryptedData; 
                img.onload = () => { 
                    loader.style.display = 'none'; 
                    initZoomDimensions();
                    applyZoom();
                }; 
                container.appendChild(img);
            } else {
                try {
                    const bin = atob(decryptedData.split(',')[1]);
                    const bytes = new Uint8Array(bin.length);
                    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
                    currentPDF = await pdfjsLib.getDocument({ data: bytes, cMapUrl: CMAP_URL, cMapPacked: true }).promise;
                    
                    const wrapper = document.createElement('div'); 
                    wrapper.className = 'pdf-canvas-container'; 
                    container.appendChild(wrapper);
                    
                    const dpr = window.devicePixelRatio || 1;
                    for (let i = 1; i <= currentPDF.numPages; i++) {
                        const page = await currentPDF.getPage(i);
                        const ovp = page.getViewport({ scale: 1 });
                        const scale = Math.max((mc.clientWidth * 0.9) / ovp.width, 1);
                        const vp = page.getViewport({ scale: scale * dpr });
                        
                        const canvas = document.createElement('canvas');
                        canvas.className = 'pdf-page-canvas';
                        canvas.height = vp.height; canvas.width = vp.width;
                        canvas.style.width = (vp.width / dpr) + "px"; 
                        canvas.style.height = (vp.height / dpr) + "px";
                        
                        await page.render({ canvasContext: canvas.getContext('2d', { alpha: false }), viewport: vp }).promise;
                        wrapper.appendChild(canvas);
                        
                        if (i === 1) loader.style.display = 'none';
                    }
                    
                    initZoomDimensions();
                    applyZoom();
                    mc.scrollTop = 0; 
                } catch (e) { loader.style.display = 'none'; showToast("描画失敗"); }
            }
        }

        function initZoomDimensions() {
            const mc = document.getElementById('mediaContainer');
            const wrapper = document.getElementById('zoomWrapper');
            if (wrapper && mc) { wrapper.style.width = '100%'; wrapper.style.height = 'auto'; }
        }

        function zoomContent(factor) {
            wakeControls();
            if (isSlideshowPlaying) toggleSlideshow(); 
            const mc = document.getElementById('mediaContainer');
            const wrapper = document.getElementById('zoomWrapper');
            if (!wrapper) return;
            const prevZoom = currentZoom;
            currentZoom *= factor;
            currentZoom = Math.min(Math.max(currentZoom, 0.5), 10);
            const centerX_Ratio = (mc.scrollLeft + mc.clientWidth / 2) / wrapper.scrollWidth;
            const centerY_Ratio = (mc.scrollTop + mc.clientHeight / 2) / wrapper.scrollHeight;
            applyZoom();
            requestAnimationFrame(() => {
                mc.scrollLeft = (centerX_Ratio * wrapper.scrollWidth) - (mc.clientWidth / 2);
                mc.scrollTop = (centerY_Ratio * wrapper.scrollHeight) - (mc.clientHeight / 2);
            });
        }

        function rotateContent() {
            wakeControls();
            if (isSlideshowPlaying) toggleSlideshow();
            currentRotation = (currentRotation + 90) % 360;
            applyZoom();
        }

        function resetZoom() {
            wakeControls();
            currentZoom = 1; currentRotation = 0; applyZoom();
            const mc = document.getElementById('mediaContainer');
            if (mc) { mc.scrollLeft = 0; mc.scrollTop = 0; }
        }

        function applyZoom() {
            const wrapper = document.getElementById('zoomWrapper');
            const mc = document.getElementById('mediaContainer');
            if (wrapper && mc) {
                wrapper.style.transform = `scale(${currentZoom}) rotate(${currentRotation}deg)`;
                const isOverflowing = (wrapper.offsetHeight * currentZoom > mc.clientHeight) || (wrapper.offsetWidth * currentZoom > mc.clientWidth);
                if (isOverflowing || currentZoom > 1.0) {
                    mc.style.alignItems = 'flex-start'; mc.style.justifyContent = 'flex-start';
                } else {
                    mc.style.alignItems = 'center'; mc.style.justifyContent = 'center';
                }
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenEnabled) { showToast("全画面表示が許可されていません"); toggleFocusMode(); return; }
            try { if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); } else { document.exitFullscreen(); } } catch (err) {}
        }

        function toggleFocusMode() { document.body.classList.toggle('hide-header'); window.dispatchEvent(new Event('resize')); }

        async function lockVault() {
            if (isSlideshowPlaying) toggleSlideshow();
            sessionKey = null; library = []; currentIdx = -1; selectedIds.clear(); isSelectMode = false;
            if (currentPDF) { await currentPDF.destroy(); currentPDF = null; }
            const main = document.getElementById('mainContent');
            main.classList.remove('opacity-100', 'hide-header');
            main.classList.add('opacity-0');
            setTimeout(() => {
                main.classList.add('hidden');
                document.getElementById('authOverlay').style.display = 'flex';
                document.getElementById('fileGrid').innerHTML = '';
                showToast("ロック完了");
            }, 500);
        }

        function closeConfirm() { document.getElementById('confirmModal').classList.add('hidden'); deleteTargetIds = []; }
        
        async function exportFullBackup() {
            const btn = document.getElementById('exportBtn'); if(btn) btn.textContent = "処理中...";
            try {
                const tx = db.transaction(CONFIG_STORE, "readonly");
                const saltObj = await new Promise(r => { const req = tx.objectStore(CONFIG_STORE).get("system_salt"); req.onsuccess = () => r(req.result); });
                const challengeObj = await new Promise(r => { const req = tx.objectStore(CONFIG_STORE).get("auth_challenge"); req.onsuccess = () => r(req.result); });
                const backupData = { version: "Final", salt: saltObj?.value, challenge: challengeObj, assets: library };
                const blob = new Blob([JSON.stringify(backupData)], { type: "application/json" });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                a.download = `vault-export-${new Date().toISOString().split('T')[0]}.json`; a.click();
                showToast("保存完了");
            } catch (e) { showToast("失敗"); } finally { if(btn) btn.textContent = "書込"; }
        }

        async function importFullBackup(input) {
            const file = input.files[0]; if (!file) return;
            const rd = new FileReader();
            rd.onload = async e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data) return;
                    const txConfig = db.transaction(CONFIG_STORE, "readwrite");
                    if (data.salt) txConfig.objectStore(CONFIG_STORE).put({ key: "system_salt", value: data.salt });
                    if (data.challenge) txConfig.objectStore(CONFIG_STORE).put({ key: "auth_challenge", value: data.challenge.value, iv: data.challenge.iv });
                    await new Promise(r => txConfig.oncomplete = r);
                    const txAssets = db.transaction(STORE_NAME, "readwrite");
                    const assetStore = txAssets.objectStore(STORE_NAME);
                    assetStore.clear();
                    const assets = data.assets || data;
                    for (const item of assets) { assetStore.put(item); }
                    txAssets.oncomplete = () => { showToast("復元完了。再起動..."); setTimeout(() => location.reload(), 1200); };
                } catch (err) { showToast("読み込み失敗"); }
            };
            rd.readAsText(file);
        }

        function toggleUploadModal() { document.getElementById('uploadModal').classList.toggle('hidden'); }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.remove('opacity-0', 'translate-y-28'); setTimeout(() => t.classList.add('opacity-0', 'translate-y-28'), 3000); }
        
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        if (dropZone) dropZone.onclick = () => fileInput.click();
        if (fileInput) fileInput.onchange = e => handleFiles(e.target.files);
        if (dropZone) {
            dropZone.addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', e => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
            dropZone.addEventListener('drop', e => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); if (sessionKey) handleFiles(e.dataTransfer.files); });
        }
        window.addEventListener('dragover', e => e.preventDefault());
        window.addEventListener('drop', e => e.preventDefault());
        
        async function closeLightboxUI() {
            if (isSlideshowPlaying) toggleSlideshow();
            clearTimeout(controlsTimer);
            document.getElementById('lightbox').classList.add('hidden'); 
            document.body.style.overflow = ''; 
            resetZoom();
            if (currentPDF) { await currentPDF.destroy(); currentPDF = null; }
        }

        document.getElementById('nextBtn').onclick = (e) => { 
            e.stopPropagation(); if (isSlideshowPlaying) toggleSlideshow();
            const sortedList = slideshowList.length > 0 ? slideshowList : getSortedLibrary(); 
            openLightbox((currentIdx + 1) % sortedList.length, sortedList); 
        };
        document.getElementById('prevBtn').onclick = (e) => { 
            e.stopPropagation(); if (isSlideshowPlaying) toggleSlideshow();
            const sortedList = slideshowList.length > 0 ? slideshowList : getSortedLibrary(); 
            openLightbox((currentIdx - 1 + sortedList.length) % sortedList.length, sortedList); 
        };
        
        const mediaContainer = document.getElementById('mediaContainer');
        ['mousemove', 'touchstart', 'scroll'].forEach(evt => {
            if (mediaContainer) mediaContainer.addEventListener(evt, wakeControls);
        });

        window.addEventListener('keydown', e => {
            if (document.getElementById('lightbox').classList.contains('hidden')) return;
            wakeControls();
            if (e.key === 'Escape') closeLightboxUI();
            if (e.key === 'ArrowRight') document.getElementById('nextBtn').click();
            if (e.key === 'ArrowLeft') document.getElementById('prevBtn').click();
            if (e.key === '+' || e.key === ';') zoomContent(1.25);
            if (e.key === '-' || e.key === '_') zoomContent(0.8);
            if (e.key === 'r' || e.key === 'R') rotateContent();
            if (e.key === ' ' || e.key === 'Enter') toggleSlideshow(); 
            if (e.key === '0') resetZoom();
        });
    </script>
</body>
</html>