<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Secure Asset Explorer - Final Pro Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; background-color: #020617; }
        
        /* PDFコンテナのスタイル */
        .pdf-canvas-container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 32px; 
            padding: 20px 0; 
            width: 100%; 
            background-color: transparent; 
        }
        .pdf-page-canvas { 
            display: block; 
            max-width: 90%; 
            height: auto !important; 
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.7); 
            background-color: white; 
            border-radius: 12px; 
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; border: 2px solid #020617; }
        
        .loader { border: 4px solid rgba(99, 102, 241, 0.1); border-top: 4px solid #6366f1; border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .asset-card { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); user-select: none; min-height: 200px; position: relative; }
        .asset-card:hover { transform: translateY(-8px); filter: brightness(1.1); }
        .asset-card.selected { outline: 4px solid #6366f1; outline-offset: 2px; }
        
        .glass-header { background: rgba(2, 6, 23, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-bg { background: rgba(0, 0, 0, 0.96); backdrop-filter: blur(12px); }
        
        /* ライトボックス内メディアコンテナの設定 */
        #mediaContainer { 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        
        /* ズーム用ラッパー */
        #zoomWrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-width: 100%;
            min-height: 100%;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: top center;
            padding: 40px 0;
        }

        #zoomWrapper > img,
        #zoomWrapper > .pdf-canvas-container {
            margin: auto;
        }

        #mediaContainer img { 
            max-width: 90%; 
            max-height: 90vh; 
            object-fit: contain; 
            display: block; 
            border-radius: 16px; 
            box-shadow: 0 40px 80px rgba(0,0,0,0.8); 
        }
        
        body.drag-active::after { content: "資産をドロップして暗号化"; position: fixed; inset: 0; z-index: 300; background: rgba(79, 70, 229, 0.8); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5rem; color: white; border: 8px dashed rgba(255,255,255,0.4); margin: 24px; border-radius: 40px; pointer-events: none; }
        
        .nav-btn {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(-50%);
        }
        .nav-btn:hover {
            background: rgba(99, 102, 241, 0.3);
            border-color: rgba(99, 102, 241, 0.5);
            color: white;
            transform: translateY(-50%) scale(1.1); 
        }

        .hide-header header { transform: translateY(-100%); pointer-events: none; }
        .hide-header main { padding-top: 0; }
        #exitFocusBtn { display: none; }
        .hide-header #exitFocusBtn { display: flex; }

        .custom-select {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #cbd5e1;
            font-size: 11px;
            font-weight: 800;
            padding: 8px 12px;
            border-radius: 10px;
            outline: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-select:hover { background: rgba(30, 41, 59, 0.9); border-color: rgba(99, 102, 241, 0.4); }

        .zoom-controls {
            position: fixed;
            top: 2rem;
            left: 2rem;
            z-index: 100;
            display: flex;
            gap: 0.5rem;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            padding: 0.5rem;
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .zoom-btn {
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border-radius: 0.75rem;
            transition: all 0.2s;
        }
        .zoom-btn:hover { background: rgba(99, 102, 241, 0.3); }
        .zoom-btn:active { scale: 0.9; }
    </style>
</head>
<body class="text-slate-200 min-h-screen selection:bg-indigo-500/30 overflow-x-hidden">

    <!-- 認証レイヤー -->
    <div id="authOverlay" class="fixed inset-0 z-[200] bg-slate-950 flex items-center justify-center p-6">
        <div class="w-full max-w-sm bg-slate-900 border border-slate-800 p-10 rounded-[3.5rem] shadow-2xl text-center">
            <!-- ロゴ画像エリア（従来のアイコンとテキストを置換） -->
            <div class="mb-10 flex justify-center">
                <img src="logo.png" alt="Logo" class="max-w-[240px] max-h-[120px] object-contain drop-shadow-2xl" onerror="this.src='https://via.placeholder.com/200x100?text=No+Logo'">
            </div>
            
            <input type="password" id="masterPassword" class="w-full bg-slate-950 border border-slate-800 rounded-2xl px-4 py-5 text-center text-white text-xl focus:border-indigo-500 outline-none transition-all mb-6 shadow-inner" placeholder="••••••••" autocomplete="current-password">
            <button onclick="authenticate()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-black py-5 rounded-2xl transition-all shadow-xl active:scale-95 uppercase italic tracking-widest">ログイン</button>
            <div class="mt-8 pt-6 border-t border-slate-800/50 text-center">
                <p class="text-[9px] text-slate-600 uppercase tracking-widest leading-loose">
                    PUBLIC GIT WARNING: <br> NEVER COMMIT YOUR EXPORTED JSON FILES.
                </p>
            </div>
        </div>
    </div>

    <!-- メインコンテンツ -->
    <div id="mainContent" class="hidden opacity-0 transition-all duration-700">
        <header class="glass-header border-b border-slate-800 sticky top-0 z-40">
            <div class="max-w-[2560px] mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center rotate-2"><svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg></div>
                        <h1 class="text-xl font-black text-white tracking-tighter uppercase italic hidden lg:block leading-none">コンテンツビューアー</h1>
                    </div>
                    <div class="flex items-center gap-2 border-l border-slate-800 pl-6">
                        <div id="normalActions" class="flex items-center gap-2">
                            <button onclick="toggleUploadModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white text-[11px] font-black px-5 py-2.5 rounded-xl transition-all active:scale-95">追加</button>
                            <button onclick="toggleSelectMode()" class="bg-slate-800 hover:bg-slate-700 text-slate-200 text-[11px] font-black px-5 py-2.5 rounded-xl transition-all active:scale-95 border border-slate-700">選択</button>
                            <button onclick="document.getElementById('importInput').click()" class="bg-slate-800 hover:bg-slate-700 text-slate-200 text-[11px] font-black px-5 py-2.5 rounded-xl transition-all active:scale-95 border border-slate-700">復元インポート</button>
                            <button onclick="exportFullBackup()" id="exportBtn" class="bg-slate-800 hover:bg-slate-700 text-slate-200 text-[11px] font-black px-5 py-2.5 rounded-xl transition-all active:scale-95 border border-slate-700 hidden md:block">エクスポート</button>
                            
                            <select id="sortSelect" onchange="renderGrid()" class="custom-select ml-2">
                                <option value="reg_desc">登録順 (新しい順)</option>
                                <option value="reg_asc">登録順 (古い順)</option>
                                <option value="file_desc">更新日時順 (新しい順)</option>
                                <option value="file_asc">更新日時順 (古い順)</option>
                                <option value="name_asc">ファイル名順 (A-Z)</option>
                                <option value="name_desc">ファイル名順 (Z-A)</option>
                                <option value="size_desc">サイズ順 (大きい順)</option>
                                <option value="size_asc">サイズ順 (小さい順)</option>
                            </select>
                            
                            <input type="file" id="importInput" class="hidden" accept=".json" onchange="importFullBackup(this)">
                        </div>
                        <div id="selectActions" class="flex gap-2 hidden">
                            <button onclick="deleteSelectedAssets()" id="bulkDeleteBtn" class="bg-red-600 hover:bg-red-500 text-white text-[11px] font-black px-5 py-2.5 rounded-xl transition-all active:scale-95">削除 (0)</button>
                            <button onclick="toggleSelectAll()" class="bg-slate-800 text-slate-200 text-[11px] font-black px-4 py-2.5 rounded-xl transition-all border border-slate-700">全選択</button>
                            <button onclick="toggleSelectMode()" class="bg-slate-200 text-slate-900 text-[11px] font-black px-4 py-2.5 rounded-xl transition-all">解除</button>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div id="storageDisplay" class="flex flex-col items-end gap-1 hidden sm:flex">
                        <div id="fileCount" class="text-[10px] font-black text-indigo-400 bg-indigo-500/10 border border-indigo-500/20 px-3 py-1 rounded-full uppercase tracking-widest leading-none text-center">登録数: 0</div>
                        <div id="storageUsage" class="text-[8px] text-slate-500 uppercase tracking-tighter">サイト全体: --MB / 空き: --GB</div>
                    </div>

                    <button onclick="toggleFocusMode()" class="text-slate-500 hover:text-white transition-colors p-1" title="枠内最大化">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                    </button>

                    <button onclick="toggleFullScreen()" class="text-slate-500 hover:text-white transition-colors p-1" title="枠を飛び出す（全画面）">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>
                    </button>
                    
                    <button onclick="lockVault()" class="text-slate-500 hover:text-white transition-colors p-1" title="ロック">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" /></svg>
                    </button>
                </div>
            </div>
        </header>
        <main class="max-w-[2560px] mx-auto px-6 py-10">
            <div id="fileGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-8"></div>
        </main>

        <button id="exitFocusBtn" onclick="toggleFocusMode()" class="fixed bottom-8 right-8 z-50 bg-indigo-600 hover:bg-indigo-500 text-white w-14 h-14 flex items-center justify-center rounded-full shadow-2xl transition-all active:scale-90 animate-bounce">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
    </div>

    <!-- 削除確認モーダル -->
    <div id="confirmModal" class="fixed inset-0 z-[300] hidden flex items-center justify-center modal-bg p-4">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-sm rounded-[3rem] p-10 shadow-2xl text-center">
            <h3 class="text-2xl font-black text-white mb-4 uppercase italic">削除しますか?</h3>
            <p id="confirmMessage" class="text-slate-400 text-sm mb-10 leading-relaxed">完全に削除します。復元はできません。</p>
            <div class="flex gap-4">
                <button onclick="closeConfirm()" class="flex-1 bg-slate-800 text-white font-bold py-4 rounded-2xl hover:bg-slate-700 transition-all">キャンセル</button>
                <button id="confirmDeleteBtn" class="flex-1 bg-red-600 text-white font-bold py-4 rounded-2xl hover:bg-red-500 transition-all shadow-xl">削除実行</button>
            </div>
        </div>
    </div>

    <!-- ライトボックス -->
    <div id="lightbox" class="fixed inset-0 z-50 hidden flex flex-col bg-black transition-all overflow-hidden select-none">
        <div class="zoom-controls">
            <button onclick="zoomContent(1.2)" class="zoom-btn" title="拡大">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M12 4v16m8-8H4"/></svg>
            </button>
            <button onclick="zoomContent(0.8)" class="zoom-btn" title="縮小">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M20 12H4"/></svg>
            </button>
            <button onclick="resetZoom()" class="zoom-btn" title="リセット">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M4 4h6v6H4zm10 0h6v6h-6zM4 14h6v6H4zm10 0h6v6h-6z"/></svg>
            </button>
        </div>

        <button id="closeBtn" class="fixed top-8 right-8 text-white/50 hover:text-white transition-all z-[80] bg-slate-900/80 p-5 rounded-full border border-white/5 active:scale-90 shadow-2xl"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M6 18L18 6M6 6l12 12" /></svg></button>
        <button id="prevBtn" class="nav-btn fixed left-6 top-1/2 w-16 h-16 flex items-center justify-center text-white/40 z-[70] rounded-full shadow-2xl"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M15 19l-7-7 7-7" /></svg></button>
        <button id="nextBtn" class="nav-btn fixed right-6 top-1/2 w-16 h-16 flex items-center justify-center text-white/40 z-[70] rounded-full shadow-2xl"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M9 5l7 7-7 7" /></svg></button>
        
        <div id="mediaContainer">
            <div id="zoomWrapper">
                <div id="mediaLoader" class="absolute inset-0 flex items-center justify-center z-[75] bg-black/90"><div class="loader"></div></div>
            </div>
        </div>
    </div>

    <div id="uploadModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center modal-bg p-4">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-lg rounded-[4rem] p-12 shadow-2xl relative">
            <button onclick="toggleUploadModal()" class="absolute top-10 right-10 text-slate-500 hover:text-white transition-colors p-2"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M6 18L18 6M6 6l12 12"/></svg></button>
            <div id="dropZone" class="border-2 border-dashed border-slate-700 bg-slate-950/50 rounded-[3rem] p-16 flex flex-col items-center justify-center group cursor-pointer hover:border-indigo-500/50 transition-all">
                <div class="w-24 h-24 bg-slate-800 rounded-[2rem] flex items-center justify-center mb-8 group-hover:scale-110 transition-all shadow-xl"><svg class="w-12 h-12 text-slate-500 group-hover:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path d="M12 4.5v15m7.5-7.5h-15"></path></svg></div>
                <h2 class="text-3xl font-black text-white mb-2 uppercase italic tracking-tighter text-center">Secure Storage</h2>
                <p class="text-slate-500 text-sm text-center">ここにドロップして保管</p>
                <input type="file" id="fileInput" class="hidden" multiple accept="image/*,application/pdf">
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-12 left-1/2 -translate-x-1/2 z-[100] bg-indigo-600 text-white px-10 py-5 rounded-3xl font-bold shadow-2xl transition-all transform translate-y-28 opacity-0 pointer-events-none text-sm text-center min-w-[320px]">メッセージ</div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const CMAP_URL = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/';
        const DB_NAME = "AssetStorage_Final_v4";
        const STORE_NAME = "assets";
        const CONFIG_STORE = "config";
        let db = null, library = [], currentIdx = -1, sessionKey = null, deleteTargetIds = [];
        let isSelectMode = false, selectedIds = new Set();
        let currentPDF = null, currentZoom = 1;

        const generateId = () => (typeof crypto.randomUUID === 'function') ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).substring(2);

        const initDB = () => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onupgradeneeded = e => {
                const database = e.target.result;
                database.createObjectStore(STORE_NAME, { keyPath: "id" });
                database.createObjectStore(CONFIG_STORE, { keyPath: "key" });
            };
            request.onsuccess = e => { db = e.target.result; };
        };
        initDB();

        async function deriveKey(password, salt) {
            return CryptoJS.PBKDF2(password, salt, { keySize: 256 / 32, iterations: 100000 });
        }

        async function authenticate() {
            if (!db) { showToast("データベース準備中..."); return; }
            const passEl = document.getElementById('masterPassword');
            const pass = passEl.value;
            if (pass.length < 4) { showToast("パスワードが短すぎます"); return; }
            
            showToast("認証中...");
            const tx = db.transaction(CONFIG_STORE, "readwrite");
            const configStore = tx.objectStore(CONFIG_STORE);
            let saltObj = await new Promise(r => { const req = configStore.get("system_salt"); req.onsuccess = () => r(req.result); });
            let challengeObj = await new Promise(r => { const req = configStore.get("auth_challenge"); req.onsuccess = () => r(req.result); });
            
            if (!saltObj) {
                const newSalt = CryptoJS.lib.WordArray.random(128/8).toString();
                saltObj = { key: "system_salt", value: newSalt };
                configStore.put(saltObj);
            }
            
            const derived = await deriveKey(pass, saltObj.value);
            if (challengeObj) {
                const testResult = decryptWithKey(challengeObj.value, challengeObj.iv, derived);
                if (testResult !== "OK") { showToast("パスワードが正しくありません"); passEl.value = ""; return; }
            } else {
                const iv = CryptoJS.lib.WordArray.random(128/8);
                const encryptedChallenge = CryptoJS.AES.encrypt("OK", derived, { iv: iv }).toString();
                configStore.put({ key: "auth_challenge", value: encryptedChallenge, iv: iv.toString() });
            }
            
            sessionKey = derived;
            passEl.value = "";
            document.getElementById('authOverlay').style.display = 'none';
            const main = document.getElementById('mainContent');
            main.classList.remove('hidden', 'opacity-0');
            
            setTimeout(async () => {
                main.classList.add('opacity-100');
                await loadFromDB();
                window.dispatchEvent(new Event('resize'));
                updateStorageUsage();
            }, 100);
        }

        async function updateStorageUsage() {
            if (navigator.storage && navigator.storage.estimate) {
                try {
                    const estimate = await navigator.storage.estimate();
                    const usage = estimate.usage || 0;
                    const quota = estimate.quota || 0;
                    const usedMB = (usage / (1024 * 1024)).toFixed(1);
                    const availableGB = ((quota - usage) / (1024 * 1024 * 1024)).toFixed(1);
                    document.getElementById('storageUsage').textContent = `サイト全体: ${usedMB}MB / 空き: ${availableGB}GB`;
                } catch(e) {}
            }
        }

        async function loadFromDB() {
            if (!db || !sessionKey) return;
            const tx = db.transaction(STORE_NAME, "readonly");
            const data = await new Promise(r => { const req = tx.objectStore(STORE_NAME).getAll(); req.onsuccess = () => r(req.result); req.onerror = () => r([]); });
            library = data;
            renderGrid();
        }

        function decryptWithKey(cipherText, ivHex, key) {
            try {
                const iv = CryptoJS.enc.Hex.parse(ivHex);
                const bytes = CryptoJS.AES.decrypt(cipherText, key, { iv: iv });
                return bytes.toString(CryptoJS.enc.Utf8) || null;
            } catch(e) { return null; }
        }

        function encrypt(text) {
            if (!text) return "";
            const iv = CryptoJS.lib.WordArray.random(128/8);
            const encrypted = CryptoJS.AES.encrypt(text, sessionKey, { iv: iv });
            return iv.toString() + ":" + encrypted.toString();
        }

        function decrypt(cipherWithIv) {
            if (!cipherWithIv || !sessionKey) return null;
            try {
                const parts = cipherWithIv.split(":");
                if (parts.length < 2) return null;
                return decryptWithKey(parts[1], parts[0], sessionKey);
            } catch(e) { return null; }
        }

        function getSortedLibrary() {
            const sortVal = document.getElementById('sortSelect').value;
            let sortedList = [...library];
            const parseSize = (s) => parseFloat(decrypt(s)?.replace(/ MB$/, '')) || 0;

            if (sortVal === 'reg_desc') {
                sortedList.sort((a, b) => b.timestamp - a.timestamp);
            } else if (sortVal === 'reg_asc') {
                sortedList.sort((a, b) => a.timestamp - b.timestamp);
            } else if (sortVal === 'file_desc') {
                sortedList.sort((a, b) => parseInt(decrypt(b.fileModified) || b.timestamp) - parseInt(decrypt(a.fileModified) || a.timestamp));
            } else if (sortVal === 'file_asc') {
                sortedList.sort((a, b) => parseInt(decrypt(a.fileModified) || a.timestamp) - parseInt(decrypt(b.fileModified) || b.timestamp));
            } else if (sortVal === 'name_asc') {
                sortedList.sort((a, b) => (decrypt(a.name) || "").localeCompare(decrypt(b.name) || "", 'ja'));
            } else if (sortVal === 'name_desc') {
                sortedList.sort((a, b) => (decrypt(b.name) || "").localeCompare(decrypt(a.name) || "", 'ja'));
            } else if (sortVal === 'size_desc') {
                sortedList.sort((a, b) => parseSize(b.size) - parseSize(a.size));
            } else if (sortVal === 'size_asc') {
                sortedList.sort((a, b) => parseSize(a.size) - parseSize(b.size));
            }
            return sortedList;
        }

        function renderGrid() {
            const grid = document.getElementById('fileGrid');
            grid.innerHTML = '';
            document.getElementById('fileCount').textContent = `登録数: ${library.length}`;
            
            if (library.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-48 text-center border-2 border-dashed border-slate-800 rounded-[4rem] bg-slate-900/10"><p class="text-slate-600 font-bold uppercase tracking-[0.4em] text-[10px]">ファイルが登録されていません。</p></div>`;
                return;
            }

            const displayList = getSortedLibrary();

            displayList.forEach((item, index) => {
                const card = document.createElement('div');
                const isSelected = selectedIds.has(item.id);
                card.className = `asset-card group bg-slate-900 border border-slate-800 rounded-3xl overflow-hidden shadow-2xl cursor-pointer ${isSelected ? 'selected' : ''}`;
                const name = decrypt(item.name) || "暗号化データ";
                const thumb = decrypt(item.thumbnail);
                
                card.innerHTML = `
                    <div class="absolute top-4 left-4 z-20 flex gap-2">
                        ${!isSelectMode ? `<button class="del-btn bg-slate-950/90 text-white/40 p-3 rounded-2xl shadow-xl border border-white/5 hover:bg-red-600 hover:text-white transition-all opacity-0 group-hover:opacity-100 scale-90 group-hover:scale-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>` : ''}
                        ${isSelectMode ? `<div class="w-8 h-8 rounded-full border-2 border-white/20 flex items-center justify-center transition-all ${isSelected ? 'bg-indigo-600 border-indigo-600' : 'bg-slate-900/80'}"><svg class="w-5 h-5 text-white ${isSelected ? '' : 'hidden'}" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg></div>` : ''}
                    </div>
                    <div class="aspect-[4/5] w-full bg-slate-950 flex items-center justify-center overflow-hidden relative">
                        <img src="${thumb || ''}" class="max-w-full max-h-full object-contain group-hover:scale-110 transition-transform duration-1000" loading="lazy">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-950/60 via-transparent to-transparent pointer-events-none"></div>
                    </div>
                    <div class="p-4 border-t border-slate-800/50 text-center bg-slate-900"><p class="text-[10px] font-black text-slate-100 truncate tracking-tight uppercase">${name}</p></div>
                `;
                card.onclick = (e) => {
                    if (isSelectMode) {
                        if (selectedIds.has(item.id)) selectedIds.delete(item.id);
                        else selectedIds.add(item.id);
                        renderGrid();
                        updateBulkDeleteCount();
                    } else {
                        if (!e.target.closest('button')) openLightbox(index, displayList);
                    }
                };
                const delBtn = card.querySelector('.del-btn');
                if (delBtn) {
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteTargetIds = [item.id];
                        document.getElementById('confirmMessage').textContent = "この資産を完全に削除します。";
                        document.getElementById('confirmModal').classList.remove('hidden');
                    };
                }
                grid.appendChild(card);
            });
        }

        function toggleSelectMode() {
            isSelectMode = !isSelectMode;
            if (!isSelectMode) selectedIds.clear();
            document.getElementById('normalActions').classList.toggle('hidden', isSelectMode);
            document.getElementById('selectActions').classList.toggle('hidden', !isSelectMode);
            updateBulkDeleteCount();
            renderGrid();
        }

        function toggleSelectAll() {
            if (selectedIds.size === library.length) selectedIds.clear();
            else library.forEach(item => selectedIds.add(item.id));
            renderGrid();
            updateBulkDeleteCount();
        }

        function updateBulkDeleteCount() {
            const btn = document.getElementById('bulkDeleteBtn');
            if(btn) btn.textContent = `削除 (${selectedIds.size})`;
        }

        function deleteSelectedAssets() {
            if (selectedIds.size === 0) return;
            deleteTargetIds = Array.from(selectedIds);
            document.getElementById('confirmMessage').textContent = `${selectedIds.size} 件の資産を完全に削除します。`;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        async function handleFiles(fileList) {
            if (!sessionKey) return;
            showToast("対応中...");
            for (const file of Array.from(fileList)) {
                try {
                    const type = file.type.startsWith('image/') ? 'image' : (file.type === 'application/pdf' ? 'pdf' : null);
                    if (!type) continue;
                    let thumbData = "";
                    if (type === 'pdf') {
                        const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer(), cMapUrl: CMAP_URL, cMapPacked: true }).promise;
                        const page = await pdf.getPage(1);
                        const canvas = document.createElement('canvas');
                        const vp = page.getViewport({ scale: 0.4 });
                        canvas.height = vp.height; canvas.width = vp.width;
                        await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
                        thumbData = canvas.toDataURL('image/jpeg', 0.6);
                        await pdf.destroy();
                    } else {
                        thumbData = await new Promise(r => { const rd = new FileReader(); rd.onload = e => r(e.target.result); rd.readAsDataURL(file); });
                    }
                    const base64 = await new Promise(r => { const rd = new FileReader(); rd.onload = e => r(e.target.result); rd.readAsDataURL(file); });
                    
                    const secureItem = { 
                        id: generateId(), 
                        name: encrypt(file.name), 
                        type: encrypt(type), 
                        size: encrypt((file.size/1024/1024).toFixed(2) + " MB"), 
                        thumbnail: encrypt(thumbData), 
                        data: encrypt(base64), 
                        timestamp: Date.now(),
                        fileModified: encrypt(file.lastModified.toString()) 
                    };
                    
                    const tx = db.transaction(STORE_NAME, "readwrite");
                    tx.objectStore(STORE_NAME).put(secureItem);
                    await new Promise(r => tx.oncomplete = r);
                } catch (err) { showToast("エラーが発生しました"); }
            }
            showToast("完了しました");
            if (!document.getElementById('uploadModal').classList.contains('hidden')) toggleUploadModal();
            loadFromDB();
            updateStorageUsage();
        }

        async function openLightbox(index, sortedList = null) {
            const list = sortedList || getSortedLibrary();
            if (index < 0 || index >= list.length) return;
            currentIdx = index;
            resetZoom();

            const item = list[index], container = document.getElementById('zoomWrapper'), loader = document.getElementById('mediaLoader'), lb = document.getElementById('lightbox'), mc = document.getElementById('mediaContainer');
            if (currentPDF) { await currentPDF.destroy(); currentPDF = null; }
            loader.style.display = 'flex';
            container.querySelectorAll('img, canvas, div:not(#mediaLoader)').forEach(el => el.remove());
            mc.scrollTop = 0; lb.classList.remove('hidden'); document.body.style.overflow = 'hidden';
            
            const decryptedData = decrypt(item.data), type = decrypt(item.type);
            if (!decryptedData) { showToast("復号に失敗しました"); loader.style.display = 'none'; return; }
            
            if (type === 'image') {
                const img = new Image(); 
                img.src = decryptedData; 
                img.onload = () => loader.style.display = 'none'; 
                container.appendChild(img);
            } else {
                try {
                    const bin = atob(decryptedData.split(',')[1]);
                    const bytes = new Uint8Array(bin.length);
                    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
                    currentPDF = await pdfjsLib.getDocument({ data: bytes, cMapUrl: CMAP_URL, cMapPacked: true }).promise;
                    
                    const wrapper = document.createElement('div'); 
                    wrapper.className = 'pdf-canvas-container';
                    container.appendChild(wrapper);
                    
                    const dpr = window.devicePixelRatio || 1;
                    for (let i = 1; i <= currentPDF.numPages; i++) {
                        const page = await currentPDF.getPage(i);
                        const ovp = page.getViewport({ scale: 1 });
                        const scale = Math.max((mc.clientWidth * 0.9) / ovp.width, 1);
                        const vp = page.getViewport({ scale: scale * dpr });
                        const canvas = document.createElement('canvas');
                        canvas.className = 'pdf-page-canvas';
                        canvas.height = vp.height; canvas.width = vp.width;
                        canvas.style.width = (vp.width / dpr) + "px"; canvas.style.height = (vp.height / dpr) + "px";
                        await page.render({ canvasContext: canvas.getContext('2d', { alpha: false }), viewport: vp }).promise;
                        wrapper.appendChild(canvas);
                        if (i === 1) loader.style.display = 'none';
                    }
                } catch (e) { loader.style.display = 'none'; showToast("描画失敗"); }
            }
        }

        function zoomContent(factor) {
            currentZoom *= factor;
            currentZoom = Math.min(Math.max(currentZoom, 0.5), 8);
            applyZoom();
        }

        function resetZoom() {
            currentZoom = 1;
            applyZoom();
        }

        function applyZoom() {
            const wrapper = document.getElementById('zoomWrapper');
            if (wrapper) {
                wrapper.style.transform = `scale(${currentZoom})`;
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenEnabled) {
                showToast("全画面表示が許可されていません（拡大表示に切り替えます）");
                toggleFocusMode();
                return;
            }
            try {
                if (!document.fullscreenElement) {
                    const p = document.documentElement.requestFullscreen();
                    if (p) p.catch(() => toggleFocusMode());
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                }
            } catch (err) { toggleFocusMode(); }
        }

        function toggleFocusMode() {
            document.body.classList.toggle('hide-header');
            window.dispatchEvent(new Event('resize'));
            if (document.body.classList.contains('hide-header')) {
                showToast("最大表示中（右下の×で解除）");
            }
        }

        async function lockVault() {
            sessionKey = null; library = []; currentIdx = -1; selectedIds.clear(); isSelectMode = false;
            if (currentPDF) { await currentPDF.destroy(); currentPDF = null; }
            const main = document.getElementById('mainContent');
            main.classList.remove('opacity-100', 'hide-header');
            main.classList.add('opacity-0');
            setTimeout(() => {
                main.classList.add('hidden');
                document.getElementById('authOverlay').style.display = 'flex';
                document.getElementById('fileGrid').innerHTML = '';
                showToast("ロック完了");
            }, 500);
        }

        function closeConfirm() { document.getElementById('confirmModal').classList.add('hidden'); deleteTargetIds = []; }
        
        document.getElementById('confirmDeleteBtn').onclick = async () => {
            if (deleteTargetIds.length === 0) return;
            const tx = db.transaction(STORE_NAME, "readwrite");
            const store = tx.objectStore(STORE_NAME);
            deleteTargetIds.forEach(id => store.delete(id));
            tx.oncomplete = () => {
                closeConfirm();
                if (isSelectMode) toggleSelectMode();
                loadFromDB();
                showToast("削除しました");
                updateStorageUsage();
            };
        };

        async function exportFullBackup() {
            const btn = document.getElementById('exportBtn'); if(btn) btn.textContent = "処理中...";
            try {
                const tx = db.transaction(CONFIG_STORE, "readonly");
                const saltObj = await new Promise(r => { const req = tx.objectStore(CONFIG_STORE).get("system_salt"); req.onsuccess = () => r(req.result); });
                const challengeObj = await new Promise(r => { const req = tx.objectStore(CONFIG_STORE).get("auth_challenge"); req.onsuccess = () => r(req.result); });
                const backupData = { version: "Final", salt: saltObj?.value, challenge: challengeObj, assets: library };
                const blob = new Blob([JSON.stringify(backupData)], { type: "application/json" });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                a.download = `vault-secure-export-${new Date().toISOString().split('T')[0]}.json`; a.click();
                showToast("エクスポート完了");
            } catch (e) { showToast("失敗"); }
            finally { if(btn) btn.textContent = "エクスポート"; }
        }

        async function importFullBackup(input) {
            const file = input.files[0]; if (!file) return;
            const rd = new FileReader();
            rd.onload = async e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data || (!data.assets && !Array.isArray(data))) {
                        showToast("データが空か不正な形式です"); return;
                    }
                    const txConfig = db.transaction(CONFIG_STORE, "readwrite");
                    if (data.salt) txConfig.objectStore(CONFIG_STORE).put({ key: "system_salt", value: data.salt });
                    if (data.challenge) txConfig.objectStore(CONFIG_STORE).put({ key: "auth_challenge", value: data.challenge.value, iv: data.challenge.iv });
                    await new Promise(r => txConfig.oncomplete = r);
                    const txAssets = db.transaction(STORE_NAME, "readwrite");
                    const assetStore = txAssets.objectStore(STORE_NAME);
                    assetStore.clear();
                    const assets = data.assets || data;
                    for (const item of assets) { assetStore.put(item); }
                    txAssets.oncomplete = () => { showToast("復元完了。再起動中..."); setTimeout(() => location.reload(), 1200); };
                } catch (err) { showToast("読み込み中にエラーが発生しました"); }
            };
            rd.readAsText(file);
        }

        function toggleUploadModal() { document.getElementById('uploadModal').classList.toggle('hidden'); }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.remove('opacity-0', 'translate-y-28'); setTimeout(() => t.classList.add('opacity-0', 'translate-y-28'), 3000); }
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = e => handleFiles(e.target.files);
        window.addEventListener('dragenter', e => { e.preventDefault(); if(sessionKey) document.body.classList.add('drag-active'); });
        window.addEventListener('dragover', e => e.preventDefault());
        window.addEventListener('dragleave', e => { if (e.relatedTarget === null) document.body.classList.remove('drag-active'); });
        window.addEventListener('drop', e => { e.preventDefault(); document.body.classList.remove('drag-active'); if (sessionKey) handleFiles(e.dataTransfer.files); });
        
        document.getElementById('closeBtn').onclick = async () => { 
            document.getElementById('lightbox').classList.add('hidden'); document.body.style.overflow = ''; 
            resetZoom();
            if (currentPDF) { await currentPDF.destroy(); currentPDF = null; }
        };
        
        document.getElementById('nextBtn').onclick = (e) => { 
            e.stopPropagation(); 
            const sortedList = getSortedLibrary();
            openLightbox((currentIdx + 1) % sortedList.length, sortedList); 
        };
        document.getElementById('prevBtn').onclick = (e) => { 
            e.stopPropagation(); 
            const sortedList = getSortedLibrary();
            openLightbox((currentIdx - 1 + sortedList.length) % sortedList.length, sortedList); 
        };
        
        window.addEventListener('keydown', e => {
            if (document.getElementById('lightbox').classList.contains('hidden')) return;
            if (e.key === 'Escape') document.getElementById('closeBtn').click();
            if (e.key === 'ArrowRight') document.getElementById('nextBtn').click();
            if (e.key === 'ArrowLeft') document.getElementById('prevBtn').click();
            if (e.key === '+' || e.key === ';') zoomContent(1.2);
            if (e.key === '-' || e.key === '_') zoomContent(0.8);
            if (e.key === '0') resetZoom();
        });
    </script>
</body>
</html>